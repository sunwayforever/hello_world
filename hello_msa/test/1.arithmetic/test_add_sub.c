// 2023-04-14 10:44
#include <mips_msa.h>
#include <msa_test.h>
// clang-format off
// ADDV.df1 V2 addv_df(V,V) v3 + v Add
// ADDVI.df V addvi_df(V,K4) v + k5 Add Immediate (immediate value is unsigned)
// ADD_A.df V add_a_df(V,V) Add Absolute Values
// ADDS_A.df V adds_a_df(V,V) Saturated Add Absolute Values
// ADDS_S.df V adds_s_df(V,V) Signed Saturated Add
// ADDS_U.df V adds_u_df(V,V) Unsigned Saturated Add
// HADD_S.df V hadd_s_df(W6,W) Signed Horizontal Add
// HADD_U.df V hadd_u_df(W,W) Unsigned Horizontal Add
//
// MADDV.df V maddv_df(V,V) v + v * v Multiply-Add
// MSUBV.df V msubv_df(V,V) v - v * v Multiply-Subtract
//
// SUBS_S.df V subs_s_df(V,V) Signed Saturated Subtract
// SUBS_U.df V subs_u_df(V,V) Unsigned Saturated Subtract
// HSUB_S.df V hsub_s_df(W,W) Signed Horizontal Subtract
// HSUB_U.df V hsub_u_df(W,W) Unsigned Horizontal Subtract
// SUBV.df V subv_df(V,V) v - v Subtract
// SUBVI.df V subvi_df(V,K) v - k Subtract Immediate (immediate value isunsigned)
//
// ASUB_S.df V asub_s_df(V,V) Absolute Value of Signed Subtract
// ASUB_U.df V asub_u_df(V,V) Absolute Value of Unsigned Subtract
//
// SAT_S.df V sat_s_df(V,V) Signed Saturate
// SAT_U.df V sat_u_df(V,V) Unsigned Saturate
//
// clang-format on
TEST_CASE(test_addv_b) {
    struct {
        int8_t a[16];
        int8_t b[16];
        int8_t r[16];
    } test_vec[] = {
        {{-51, 8, -16, -79, -121, -101, -47, 115, 28, -124, -17, -117, -124,
          -22, 125, 109},
         {-103, 43, -76, -98, -75, 79, -61, 120, 14, -125, 88, 115, -23, 119,
          -31, -73},
         {102, 51, -92, 79, 60, -22, -108, -21, 42, 7, 71, -2, 109, 97, 94,
          36}},
        {{INT8_MAX, -47, 104, 6, 109, 57, 121, 6, -20, INT8_MIN, 37, 112, 106,
          -94, -35, 120},
         {100, 45, -92, 25, 125, 104, -111, -103, 37, 54, -20, 14, -83, -51,
          -59, 44},
         {-29, -2, 12, 31, -22, -95, 10, -97, 17, -74, 17, 126, 23, 111, -94,
          -92}},
        {{-98, 45, 51, 11, 102, -84, 17, -53, -10, 21, 122, 97, -73, 88, -39,
          -36},
         {-38, -74, -28, 87, 30, 118, -16, 10, -114, -59, -21, 59, -110, -80,
          103, 49},
         {120, -29, 23, 98, -124, 34, 1, -43, -124, -38, 101, -100, 73, 8, 64,
          13}},
        {{-34, -102, 60, 68, 71, 78, 15, 33, 126, -90, -63, 53, -2, -101, 18,
          -116},
         {4, -12, 120, 34, 106, 104, 44, 96, 96, -3, -57, -13, -83, 47, 36,
          -117},
         {-30, -114, -76, 102, -79, -74, 59, -127, -34, -93, -120, 40, -85, -54,
          54, 23}},
    };
    for (size_t i = 0; i < (sizeof(test_vec) / sizeof(test_vec[0])); i++) {
        v16i8 a = __msa_ld_b(test_vec[i].a, 0);
        v16i8 b = __msa_ld_b(test_vec[i].b, 0);
        v16i8 r = __msa_addv_b(a, b);
        v16i8 check = __msa_ld_b(test_vec[i].r, 0);
        ASSERT_EQUAL(check, r);
    }
    return 0;
}

TEST_CASE(test_addvi_b) {
    struct {
        int8_t a[16];
        int8_t r[16];
    } test_vec[] = {
        {{-51, 8, -16, -79, -121, -101, -47, 115, 28, -124, -17, -117, -124,
          -22, 125, 109},
         {-50, 9, -15, -78, -120, -100, -46, 116, 29, -123, -16, -116, -123,
          -21, 126, 110}},
        {{INT8_MAX, -47, 104, 6, 109, 57, 121, 6, -20, INT8_MIN, 37, 112, 106,
          -94, -35, 120},
         {INT8_MIN, -46, 105, 7, 110, 58, 122, 7, -19, -127, 38, 113, 107, -93,
          -34, 121}},
        {
            {-98, 45, 51, 11, 102, -84, 17, -53, -10, 21, 122, 97, -73, 88, -39,
             -36},
            {-97, 46, 52, 12, 103, -83, 18, -52, -9, 22, 123, 98, -72, 89, -38,
             -35},
        },
    };
    for (size_t i = 0; i < (sizeof(test_vec) / sizeof(test_vec[0])); i++) {
        v16i8 a = __msa_ld_b(test_vec[i].a, 0);
        v16i8 r = __msa_addvi_b(a, 1);
        v16i8 check = __msa_ld_b(test_vec[i].r, 0);
        ASSERT_EQUAL(check, r);
    }
    return 0;
}

TEST_CASE(test_add_a_b) {
    struct {
        int8_t a[16];
        int8_t b[16];
        int8_t r[16];
    } test_vec[] = {
        {
            {-51, 8, -16, -79, -121, -101, -47, 115, 28, -124, -17, -117, -124,
             -22, 125, 109},
            {-103, 43, -76, -98, -75, 79, -61, 120, 14, -125, 88, 115, -23, 119,
             -31, -73},
            {-102, 51, 92, -79, -60, -76, 108, -21, 42, -7, 105, -24, -109,
             -115, -100, -74},
        },
        {
            {INT8_MAX, -47, 104, 6, 109, 57, 121, 6, -20, INT8_MIN, 37, 112,
             106, -94, -35, 120},
            {100, 45, -92, 25, 125, 104, -111, -103, 37, 54, -20, 14, -83, -51,
             -59, 44},
            {-29, 92, -60, 31, -22, -95, -24, 109, 57, -74, 57, 126, -67, -111,
             94, -92},
        },
        {
            {-98, 45, 51, 11, 102, -84, 17, -53, -10, 21, 122, 97, -73, 88, -39,
             -36},
            {-38, -74, -28, 87, 30, 118, -16, 10, -114, -59, -21, 59, -110, -80,
             103, 49},
            {-120, 119, 79, 98, -124, -54, 33, 63, 124, 80, -113, -100, -73,
             -88, -114, 85},
        },
        {
            {-34, -102, 60, 68, 71, 78, 15, 33, 126, -90, -63, 53, -2, -101, 18,
             -116},
            {4, -12, 120, 34, 106, 104, 44, 96, 96, -3, -57, -13, -83, 47, 36,
             -117},
            {38, 114, -76, 102, -79, -74, 59, -127, -34, 93, 120, 66, 85, -108,
             54, -23},
        },
    };
    for (size_t i = 0; i < (sizeof(test_vec) / sizeof(test_vec[0])); i++) {
        v16i8 a = __msa_ld_b(test_vec[i].a, 0);
        v16i8 b = __msa_ld_b(test_vec[i].b, 0);
        v16i8 r = __msa_add_a_b(a, b);
        v16i8 check = __msa_ld_b(test_vec[i].r, 0);
        ASSERT_EQUAL(check, r);
    }
    return 0;
}

TEST_CASE(test_adds_a_b) {
    struct {
        int8_t a[16];
        int8_t b[16];
        int8_t r[16];
    } test_vec[] = {
        {{-51, 8, -16, -79, -121, -101, -47, 115, 28, -124, -17, -117, -124,
          -22, 125, 109},
         {-103, 43, -76, -98, -75, 79, -61, 120, 14, -125, 88, 115, -23, 119,
          -31, -73},
         {127, 51, 92, 127, 127, 127, 108, 127, 42, 127, 105, 127, 127, 127,
          127, 127}},
        {{INT8_MAX, -47, 104, 6, 109, 57, 121, 6, -20, INT8_MIN, 37, 112, 106,
          -94, -35, 120},
         {100, 45, -92, 25, 125, 104, -111, -103, 37, 54, -20, 14, -83, -51,
          -59, 44},
         {127, 92, 127, 31, 127, 127, 127, 109, 57, 127, 57, 126, 127, 127, 94,
          127}},
        {{-98, 45, 51, 11, 102, -84, 17, -53, -10, 21, 122, 97, -73, 88, -39,
          -36},
         {-38, -74, -28, 87, 30, 118, -16, 10, -114, -59, -21, 59, -110, -80,
          103, 49},
         {127, 119, 79, 98, 127, 127, 33, 63, 124, 80, 127, 127, 127, 127, 127,
          85}},
        {{-34, -102, 60, 68, 71, 78, 15, 33, 126, -90, -63, 53, -2, -101, 18,
          -116},
         {4, -12, 120, 34, 106, 104, 44, 96, 96, -3, -57, -13, -83, 47, 36,
          -117},
         {38, 114, 127, 102, 127, 127, 59, 127, 127, 93, 120, 66, 85, 127, 54,
          127}},
    };
    for (size_t i = 0; i < (sizeof(test_vec) / sizeof(test_vec[0])); i++) {
        v16i8 a = __msa_ld_b(test_vec[i].a, 0);
        v16i8 b = __msa_ld_b(test_vec[i].b, 0);
        v16i8 r = __msa_adds_a_b(a, b);
        v16i8 check = __msa_ld_b(test_vec[i].r, 0);
        ASSERT_EQUAL(check, r);
    }
    return 0;
}

TEST_CASE(test_adds_s_b) {
    struct {
        int8_t a[16];
        int8_t b[16];
        int8_t r[16];
    } test_vec[] = {
        {{-51, 8, -16, -79, -121, -101, -47, 115, 28, -124, -17, -117, -124,
          -22, 125, 109},
         {-103, 43, -76, -98, -75, 79, -61, 120, 14, -125, 88, 115, -23, 119,
          -31, -73},
         {-128, 51, -92, -128, -128, -22, -108, 127, 42, -128, 71, -2, -128, 97,
          94, 36}},
        {{INT8_MAX, -47, 104, 6, 109, 57, 121, 6, -20, INT8_MIN, 37, 112, 106,
          -94, -35, 120},
         {100, 45, -92, 25, 125, 104, -111, -103, 37, 54, -20, 14, -83, -51,
          -59, 44},
         {127, -2, 12, 31, 127, 127, 10, -97, 17, -74, 17, 126, 23, -128, -94,
          127}},
        {{-98, 45, 51, 11, 102, -84, 17, -53, -10, 21, 122, 97, -73, 88, -39,
          -36},
         {-38, -74, -28, 87, 30, 118, -16, 10, -114, -59, -21, 59, -110, -80,
          103, 49},
         {-128, -29, 23, 98, 127, 34, 1, -43, -124, -38, 101, 127, -128, 8, 64,
          13}},
        {{-34, -102, 60, 68, 71, 78, 15, 33, 126, -90, -63, 53, -2, -101, 18,
          -116},
         {4, -12, 120, 34, 106, 104, 44, 96, 96, -3, -57, -13, -83, 47, 36,
          -117},
         {-30, -114, 127, 102, 127, 127, 59, 127, 127, -93, -120, 40, -85, -54,
          54, -128}},
    };
    for (size_t i = 0; i < (sizeof(test_vec) / sizeof(test_vec[0])); i++) {
        v16i8 a = __msa_ld_b(test_vec[i].a, 0);
        v16i8 b = __msa_ld_b(test_vec[i].b, 0);
        v16i8 r = __msa_adds_s_b(a, b);
        v16i8 check = __msa_ld_b(test_vec[i].r, 0);
        ASSERT_EQUAL(check, r);
    }
    return 0;
}

TEST_CASE(test_adds_u_b) {
    struct {
        int8_t a[16];
        int8_t b[16];
        uint8_t r[16];
    } test_vec[] = {
        {{-51, 8, -16, -79, -121, -101, -47, 115, 28, -124, -17, -117, -124,
          -22, 125, 109},
         {-103, 43, -76, -98, -75, 79, -61, 120, 14, -125, 88, 115, -23, 119,
          -31, -73},
         {255, 51, 255, 255, 255, 234, 255, 235, 42, 255, 255, 254, 255, 255,
          255, 255}},
        {{INT8_MAX, -47, 104, 6, 109, 57, 121, 6, -20, INT8_MIN, 37, 112, 106,
          -94, -35, 120},
         {100, 45, -92, 25, 125, 104, -111, -103, 37, 54, -20, 14, -83, -51,
          -59, 44},
         {227, 254, 255, 31, 234, 161, 255, 159, 255, 182, 255, 126, 255, 255,
          255, 164}},
        {{-98, 45, 51, 11, 102, -84, 17, -53, -10, 21, 122, 97, -73, 88, -39,
          -36},
         {-38, -74, -28, 87, 30, 118, -16, 10, -114, -59, -21, 59, -110, -80,
          103, 49},
         {255, 227, 255, 98, 132, 255, 255, 213, 255, 218, 255, 156, 255, 255,
          255, 255}},
        {{-34, -102, 60, 68, 71, 78, 15, 33, 126, -90, -63, 53, -2, -101, 18,
          -116},
         {4, -12, 120, 34, 106, 104, 44, 96, 96, -3, -57, -13, -83, 47, 36,
          -117},
         {226, 255, 180, 102, 177, 182, 59, 129, 222, 255, 255, 255, 255, 202,
          54, 255}},
    };
    for (size_t i = 0; i < (sizeof(test_vec) / sizeof(test_vec[0])); i++) {
        m128 a, b, r, check;
        a.i8 = __msa_ld_b(test_vec[i].a, 0);
        b.i8 = __msa_ld_b(test_vec[i].b, 0);
        r.u8 = __msa_adds_u_b(a.u8, b.u8);
        check.i8 = __msa_ld_b(test_vec[i].r, 0);
        ASSERT_EQUAL(check.u8, r.u8);
    }
    return 0;
}

TEST_CASE(test_hadd_s_b) {
    struct {
        int8_t a[16];
        int8_t b[16];
        int16_t r[8];
    } test_vec[] = {
        {{-51, 8, -16, -79, -121, -101, -47, 115, 28, -124, -17, -117, -124,
          -22, 125, 109},
         {-103, 43, -76, -98, -75, 79, -61, 120, 14, -125, 88, 115, -23, 119,
          -31, -73},
         {-95, -155, -176, 54, -110, -29, -45, 78}},
        {{INT8_MAX, -47, 104, 6, 109, 57, 121, 6, -20, INT8_MIN, 37, 112, 106,
          -94, -35, 120},
         {100, 45, -92, 25, 125, 104, -111, -103, 37, 54, -20, 14, -83, -51,
          -59, 44},
         {53, -86, 182, -105, -91, 92, -177, 61}},
        {{-98, 45, 51, 11, 102, -84, 17, -53, -10, 21, 122, 97, -73, 88, -39,
          -36},
         {-38, -74, -28, 87, 30, 118, -16, 10, -114, -59, -21, 59, -110, -80,
          103, 49},
         {7, -17, -54, -69, -93, 76, -22, 67}},
        {{-34, -102, 60, 68, 71, 78, 15, 33, 126, -90, -63, 53, -2, -101, 18,
          -116},
         {4, -12, 120, 34, 106, 104, 44, 96, 96, -3, -57, -13, -83, 47, 36,
          -117},
         {-98, 188, 184, 77, 6, -4, -184, -80}},
    };
    for (size_t i = 0; i < (sizeof(test_vec) / sizeof(test_vec[0])); i++) {
        v16i8 a = __msa_ld_b(test_vec[i].a, 0);
        v16i8 b = __msa_ld_b(test_vec[i].b, 0);
        v8i16 r = __msa_hadd_s_h(a, b);
        v8i16 check = __msa_ld_h(test_vec[i].r, 0);
        ASSERT_EQUAL(check, r);
    }
    return 0;
}

TEST_CASE(test_asub_s_b) {
    struct {
        int8_t a[16];
        int8_t b[16];
        int8_t r[16];
    } test_vec[] = {
        {{-51, 8, -16, -79, -121, -101, -47, 115, 28, -124, -17, -117, -124,
          -22, 125, 109},
         {-103, 43, -76, -98, -75, 79, -61, 120, 14, -125, 88, 115, -23, 119,
          -31, -73},
         {52, 35, 60, 19, 46, -76, 14, 5, 14, 1, 105, -24, 101, -115, -100,
          -74}},
        {{INT8_MAX, -47, 104, 6, 109, 57, 121, 6, -20, INT8_MIN, 37, 112, 106,
          -94, -35, 120},
         {100, 45, -92, 25, 125, 104, -111, -103, 37, 54, -20, 14, -83, -51,
          -59, 44},
         {27, 92, -60, 19, 16, 47, -24, 109, 57, -74, 57, 98, -67, 43, 24, 76}},
    };
    for (size_t i = 0; i < (sizeof(test_vec) / sizeof(test_vec[0])); i++) {
        v16i8 a = __msa_ld_b(test_vec[i].a, 0);
        v16i8 b = __msa_ld_b(test_vec[i].b, 0);
        v16i8 r = __msa_asub_s_b(a, b);
        v16i8 check = __msa_ld_b(test_vec[i].r, 0);
        ASSERT_EQUAL(check, r);
    }
    return 0;
}

TEST_CASE(test_maddv_b) {
    struct {
        int8_t c[16];
        int8_t a[16];
        int8_t b[16];
        int8_t r[16];
    } test_vec[] = {
        {
            {-98, 45, 51, 11, 102, -84, 17, -53, -10, 21, 122, 97, -73, 88, -39,
             -36},
            {-51, 8, -16, -79, -121, -101, -47, 115, 28, -124, -17, -117, -124,
             -22, 125, 109},
            {-103, 43, -76, -98, -75, 79, -61, 120, 14, -125, 88, 115, -23, 119,
             -31, -73},
            {35, -123, -13, 73, -39, -127, 68, -77, 126, -95, -94, -46, -37, 30,
             -74, -57},
        },
        {
            {-34, -102, 60, 68, 71, 78, 15, 33, 126, -90, -63, 53, -2, -101, 18,
             -116},
            {INT8_MAX, -47, 104, 6, 109, 57, 121, 6, -20, INT8_MIN, 37, 112,
             106, -94, -35, 120},
            {100, 45, -92, 25, 125, 104, -111, -103, 37, 54, -20, 14, -83, -51,
             -59, 44},
            {122, 87, -36, -38, -128, 118, -104, -73, -102, -90, -35, 85, -96,
             85, 35, 44},
        },
    };
    for (size_t i = 0; i < (sizeof(test_vec) / sizeof(test_vec[0])); i++) {
        v16i8 c = __msa_ld_b(test_vec[i].c, 0);
        v16i8 a = __msa_ld_b(test_vec[i].a, 0);
        v16i8 b = __msa_ld_b(test_vec[i].b, 0);
        v16i8 r = __msa_maddv_b(c, a, b);
        v16i8 check = __msa_ld_b(test_vec[i].r, 0);
        ASSERT_EQUAL(check, r);
    }
    return 0;
}

TEST_CASE(test_sat_s_b) {
    struct {
        int8_t a[16];
        int8_t r[16];
    } test_vec[] = {
        {
            {-51, 8, -16, -79, -121, -101, -47, 115, 28, -124, -17, -117, -124,
             -22, 125, 109},
            {-16, 8, -16, -16, -16, -16, -16, 15, 15, -16, -16, -16, -16, -16,
             15, 15},
        },
        {
            {INT8_MAX, -47, 104, 6, 109, 57, 121, 6, -20, INT8_MIN, 37, 112,
             106, -94, -35, 120},
            {15, -16, 15, 6, 15, 15, 15, 6, -16, -16, 15, 15, 15, -16, -16, 15},
        },

    };
    for (size_t i = 0; i < (sizeof(test_vec) / sizeof(test_vec[0])); i++) {
        v16i8 a = __msa_ld_b(test_vec[i].a, 0);
        v16i8 r = __msa_sat_s_b(a, 4);
        v16i8 check = __msa_ld_b(test_vec[i].r, 0);
        ASSERT_EQUAL(check, r);
    }
    return 0;
}
