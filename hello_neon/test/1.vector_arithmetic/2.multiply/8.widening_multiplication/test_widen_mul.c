#include <neon.h>
#include <neon_test.h>
// int16x8_t vmull_s8(int8x8_t a,int8x8_t b)
//               ^---widen
// int32x4_t vmull_s16(int16x4_t a,int16x4_t b)
// int64x2_t vmull_s32(int32x2_t a,int32x2_t b)
// uint16x8_t vmull_u8(uint8x8_t a,uint8x8_t b)
// uint32x4_t vmull_u16(uint16x4_t a,uint16x4_t b)
// uint64x2_t vmull_u32(uint32x2_t a,uint32x2_t b)
// int16x8_t vmull_high_s8(int8x16_t a,int8x16_t b)
//                 ^^^^---high
// int32x4_t vmull_high_s16(int16x8_t a,int16x8_t b)
// int64x2_t vmull_high_s32(int32x4_t a,int32x4_t b)
// uint16x8_t vmull_high_u8(uint8x16_t a,uint8x16_t b)
// uint32x4_t vmull_high_u16(uint16x8_t a,uint16x8_t b)

TEST_CASE(test_vmull_s8) {
    struct {
        int8_t a[8];
        int8_t b[8];
        int16_t r[8];
    } test_vec[] = {
        {{80, -57, INT8_MIN, -68, 13, -44, 8, 65},
         {-55, -20, 56, -54, 110, 55, -97, -8},
         {-4400, 1140, -7168, 3672, 1430, -2420, -776, -520}},
        {{90, 52, 32, 61, -126, 97, 42, -90},
         {100, 38, -122, 112, -57, 19, -61, 23},
         {9000, 1976, -3904, 6832, 7182, 1843, -2562, -2070}},
        {{-38, 68, -44, -24, 24, -36, 41, -31},
         {-56, 97, -85, 55, -104, 74, 47, -14},
         {2128, 6596, 3740, -1320, -2496, -2664, 1927, 434}},
        {{126, 80, 48, 1, -79, 90, -89, 21},
         {INT8_MIN, 46, -123, 72, 65, 73, 95, 28},
         {-16128, 3680, -5904, 72, -5135, 6570, -8455, 588}},
        {{-115, 51, 4, -91, 16, 45, -122, -40},
         {-114, 49, 15, 38, 123, 63, 25, -7},
         {13110, 2499, 60, -3458, 1968, 2835, -3050, 280}},
        {{-113, 73, -6, 64, -93, -94, 86, 36},
         {-48, -37, 108, 17, 36, -53, 45, -79},
         {5424, -2701, -648, 1088, -3348, 4982, 3870, -2844}},
        {{-1, 49, 86, 15, 94, -36, -25, -20},
         {13, -9, 19, -120, 54, 44, -126, -59},
         {-13, -441, 1634, -1800, 5076, -1584, 3150, 1180}},
        {{117, 124, 5, 24, 30, 91, 60, -18},
         {55, -88, 0, 91, 116, 45, 13, 115},
         {6435, -10912, 0, 2184, 3480, 4095, 780, -2070}},
    };

    for (size_t i = 0; i < (sizeof(test_vec) / sizeof(test_vec[0])); i++) {
        int8x8_t a = vld1_s8(test_vec[i].a);
        int8x8_t b = vld1_s8(test_vec[i].b);
        int16x8_t r = vmull_s8(a, b);
        int16x8_t check = vld1q_s16(test_vec[i].r);
        ASSERT_EQUAL(r, check);
    }
    return 0;
}

TEST_CASE(test_vmull_high_s8) {
    static const struct {
        int8_t a[16];
        int8_t b[16];
        int16_t r[8];
    } test_vec[] = {
        {{1, 41, INT8_MIN, 91, 79, -119, 78, -75, -74, -42, -125, -81, -49, 57,
          -30, -14},
         {81, 59, 120, 49, -28, -59, -81, -20, 66, -124, -49, INT8_MIN, 30, -80,
          -63, 32},
         {-4884, 5208, 6125, 10368, -1470, -4560, 1890, -448}},
        {{-39, 65, 123, 41, -53, -55, -34, -127, -96, 97, 48, 111, -102, 18, 97,
          -20},
         {77, -39, 29, 50, -98, -51, 30, -32, 81, -18, 96, 112, -98, 33, -112,
          120},
         {-7776, -1746, 4608, 12432, 9996, 594, -10864, -2400}},
        {{99, 11, -95, 46, -44, INT8_MAX, -81, 116, -31, -33, -29, 123, -14, 68,
          103, 63},
         {29, -123, 113, -69, 82, -112, -100, -93, 126, -4, 19, 28, 30, -93,
          -108, -127},
         {-3906, 132, -551, 3444, -420, -6324, -11124, -8001}},
        {{-82, 53, -81, -125, -75, 94, -9, -106, 61, -37, 17, 47, 31, 121, 111,
          61},
         {-2, -32, -8, 80, 112, -108, -13, -18, -111, 7, 11, -81, -86, -97, 48,
          89},
         {-6771, -259, 187, -3807, -2666, -11737, 5328, 5429}},
        {{-43, -33, -36, -118, 61, -45, 32, 122, -82, 49, -86, -50, -86, 25, 11,
          -88},
         {-7, 3, -8, 106, -104, -20, 88, 41, -13, 99, -40, -99, 3, 8, -10, -40},
         {1066, 4851, 3440, 4950, -258, 200, -110, 3520}},
        {{-25, -46, 98, 36, -90, -126, -98, 84, -77, 72, 34, 94, 97, 45, 6, 91},
         {49, -1, -59, -55, -21, 29, -14, -34, -127, -54, 123, -124, -46, 114,
          92, -71},
         {9779, -3888, 4182, -11656, -4462, 5130, 552, -6461}},
        {{68, -66, -35, -22, 64, 123, 63, -13, -60, 97, 81, 37, -113, 88,
          INT8_MIN, -64},
         {87, 69, -119, 66, 99, 123, 32, -28, 69, -101, 104, 23, 13, -60, -48,
          82},
         {-4140, -9797, 8424, 851, -1469, -5280, 6144, -5248}},
        {{-126, -83, 60, -62, 40, 123, -75, -20, -35, 7, 18, 108, 95, -110, 44,
          -74},
         {-40, -75, -8, 59, 48, 24, 31, 117, -77, -121, -116, -63, 75, 92, 19,
          -51},
         {2695, -847, -2088, -6804, 7125, -10120, 836, 3774}}};

    for (size_t i = 0; i < (sizeof(test_vec) / sizeof(test_vec[0])); i++) {
        int8x16_t a = vld1q_s8(test_vec[i].a);
        int8x16_t b = vld1q_s8(test_vec[i].b);
        int16x8_t r = vmull_high_s8(a, b);
        int16x8_t check = vld1q_s16(test_vec[i].r);
        ASSERT_EQUAL(r, check);
    }
    return 0;
}
