// 2023-04-15 22:20
#include <neon.h>
#include <neon_test.h>
// int16x8_t vmlal_s8(int16x8_t a,int8x8_t b,int8x8_t c)
//               ^--- widening, r[i]=a[i]+widen(b[i]*c[i])
// int32x4_t vmlal_s16(int32x4_t a,int16x4_t b,int16x4_t c)
// int64x2_t vmlal_s32(int64x2_t a,int32x2_t b,int32x2_t c)
// uint16x8_t vmlal_u8(uint16x8_t a,uint8x8_t b,uint8x8_t c)
// uint32x4_t vmlal_u16(uint32x4_t a,uint16x4_t b,uint16x4_t c)
// uint64x2_t vmlal_u32(uint64x2_t a,uint32x2_t b,uint32x2_t c)
//
// int16x8_t vmlal_high_s8(int16x8_t a,int8x16_t b,int8x16_t c)
//                 ^^^^--- high part, r[i]=a[i]+widen(b[i+8]*c[i+8])
// int32x4_t vmlal_high_s16(int32x4_t a,int16x8_t b,int16x8_t c)
// int64x2_t vmlal_high_s32(int64x2_t a,int32x4_t b,int32x4_t c)
// uint16x8_t vmlal_high_u8(uint16x8_t a,uint8x16_t b,uint8x16_t c)
// uint32x4_t vmlal_high_u16(uint32x4_t a,uint16x8_t b,uint16x8_t c)
// uint64x2_t vmlal_high_u32(uint64x2_t a,uint32x4_t b,uint32x4_t c)
//
// int16x8_t vmlsl_s8(int16x8_t a,int8x8_t b,int8x8_t c)
// int32x4_t vmlsl_s16(int32x4_t a,int16x4_t b,int16x4_t c)
// int64x2_t vmlsl_s32(int64x2_t a,int32x2_t b,int32x2_t c)
// uint16x8_t vmlsl_u8(uint16x8_t a,uint8x8_t b,uint8x8_t c)
// uint32x4_t vmlsl_u16(uint32x4_t a,uint16x4_t b,uint16x4_t c)
// uint64x2_t vmlsl_u32(uint64x2_t a,uint32x2_t b,uint32x2_t c)
//
// int16x8_t vmlsl_high_s8(int16x8_t a,int8x16_t b,int8x16_t c)
// int32x4_t vmlsl_high_s16(int32x4_t a,int16x8_t b,int16x8_t c)
// int64x2_t vmlsl_high_s32(int64x2_t a,int32x4_t b,int32x4_t c)
// uint16x8_t vmlsl_high_u8(uint16x8_t a,uint8x16_t b,uint8x16_t c)
// uint32x4_t vmlsl_high_u16(uint32x4_t a,uint16x8_t b,uint16x8_t c)
// uint64x2_t vmlsl_high_u32(uint64x2_t a,uint32x4_t b,uint32x4_t c)
TEST_CASE(test_vmlal_s8) {
    static const struct {
        int16_t a[8];
        int8_t b[8];
        int8_t c[8];
        int16_t r[8];
    } test_vec[] = {
        {{22815, 31689, -3101, -14571, 4624, -7544, -30491, 21581},
         {-66, 81, 115, 86, -49, -27, -75, 12},
         {-122, -95, -63, -71, 63, -125, -33, 94},
         {30867, 23994, -10346, -20677, 1537, -4169, -28016, 22709}},
        {{-22307, -16167, -4452, -21369, 3841, -6514, -9320, 22074},
         {45, -83, -84, -4, -109, 97, 8, 25},
         {3, -54, -45, 66, 77, -78, -96, 42},
         {-22172, -11685, -672, -21633, -4552, -14080, -10088, 23124}},
        {{31066, -2326, 29287, 26786, 12417, 6479, -30452, 14703},
         {55, 28, 53, -54, 125, 62, -29, INT8_MIN},
         {8, -74, -62, 85, 104, 98, INT8_MIN, -61},
         {31506, -4398, 26001, 22196, 25417, 12555, -26740, 22511}},
        {{27355, 17337, 23772, 24235, -1396, -26505, -6268, -17455},
         {3, 7, -123, INT8_MIN, 69, 104, 1, 77},
         {31, -61, -94, -121, 38, 34, 74, 1},
         {27448, 16910, -30202, -25813, 1226, -22969, -6194, -17378}},
        {{1165, 26948, -4000, -4921, 16362, 28293, 22054, 10537},
         {93, -82, -87, -94, 23, -86, -17, 54},
         {110, -110, -67, -108, -76, 8, -107, 65},
         {11395, -29568, 1829, 5231, 14614, 27605, 23873, 14047}},
        {{-9716, 27819, 29386, -19368, -8783, -10461, 19508, -28416},
         {-5, -86, 52, 18, 84, 35, 72, -62},
         {-75, 5, 86, 106, 13, -20, -85, 25},
         {-9341, 27389, -31678, -17460, -7691, -11161, 13388, -29966}},
        {{22214, -28539, -8503, 31300, 26555, -4270, 21172, -20607},
         {-4, -75, -63, 81, -40, 9, 19, -114},
         {14, 106, -8, 28, 86, -93, 53, 28},
         {22158, 29047, -7999, -31968, 23115, -5107, 22179, -23799}},
        {{-17414, -15444, -3943, 21565, -28840, 3140, -14878, -8517},
         {122, 124, 47, 82, -123, 67, -32, -109},
         {-83, -40, -81, 3, 124, -27, 31, 118},
         {-27540, -20404, -7750, 21811, 21444, 1331, -15870, -21379}},
    };

    for (size_t i = 0; i < (sizeof(test_vec) / sizeof(test_vec[0])); i++) {
        int16x8_t a = vld1q_s16(test_vec[i].a);
        int8x8_t b = vld1_s8(test_vec[i].b);
        int8x8_t c = vld1_s8(test_vec[i].c);
        int16x8_t r = vmlal_s8(a, b, c);
        int16x8_t check = vld1q_s16(test_vec[i].r);
        ASSERT_EQUAL(r, check);
    }

    return 0;
}

TEST_CASE(test_vmlal_high_s8) {
    static const struct {
        int16_t a[8];
        int8_t b[16];
        int8_t c[16];
        int16_t r[8];
    } test_vec[] = {
        {{3820, 12612, 12948, 16793, 15561, -25824, 27015, 5311},
         {40, -122, -54, -97, 0, 110, -59, -126, -26, 43, -37, -65, -9, 46, -80,
          -29},
         {60, -12, 20, -47, 38, -82, 18, -17, -22, 51, -118, 113, -100, 73,
          -123, -60},
         {4392, 14805, 17314, 9448, 16461, -22466, -28681, 7051}},
        {{20431, -12444, 10685, -23470, 11604, 19555, 4955, -26577},
         {7, 68, 105, 45, -14, 123, 29, -36, -82, -89, 77, 74, -15, -46, 15,
          -64},
         {34, 115, -112, -33, -100, -30, -125, -15, 15, -26, 61, 107, -7, 108,
          3, 0},
         {19201, -10130, 15382, -15552, 11709, 14587, 5000, -26577}},
        {{27824, -24018, 19431, -27010, -13326, -7200, -4194, -16220},
         {98, 52, -97, -1, 22, 35, -16, 37, 9, 45, -112, 3, -103, -109, 3, 74},
         {-1, 49, -20, -25, 124, 107, 125, 111, 54, 93, 82, -44, 77, -10, -108,
          -81},
         {28310, -19833, 10247, -27142, -21257, -6110, -4518, -22214}},
        {{13354, 16558, -25001, 24678, -2357, 25955, 26506, -30289},
         {-104, -101, 112, 21, 6, -19, -124, 61, 75, -42, 17, -104, -51, -90,
          71, -9},
         {-38, -10, 56, 49, -108, -98, -111, 96, -108, -11, -59, 30, 92, 116,
          -88, -12},
         {5254, 17020, -26004, 21558, -7049, 15515, 20258, -30181}},
        {{6159, 5641, -29434, 20819, 25700, 12777, 12298, -7128},
         {38, 96, 21, -69, -2, -89, 27, -109, -100, -32, -79, -8, 84, 89, -20,
          99},
         {114, -10, 121, 120, -125, -52, -55, -25, 49, -78, 24, 59, -30, 65, 32,
          9},
         {1259, 8137, -31330, 20347, 23180, 18562, 11658, -6237}},
        {{13729, -24380, -8228, 30771, -6977, 4976, 23870, -20362},
         {83, -16, 40, -42, -68, -15, -66, -19, -93, -42, 41, -123, 23, 73,
          -114, -71},
         {126, 82, 89, 91, 49, -116, -45, -16, 112, 68, 3, -82, -95, 122, 94,
          -12},
         {3313, -27236, -8105, -24679, -9162, 13882, 13154, -19510}},
        {{-31126, 9930, -30601, 6676, 15711, 30368, 11910, 1071},
         {-127, -120, 95, -78, 20, 51, -93, -123, 119, -90, 51, 24, 32, -110,
          12, -118},
         {24, -42, -79, -112, 95, -59, -86, -66, 2, 74, 52, -120, 121, 100,
          -116, -6},
         {-30888, 3270, -27949, 3796, 19583, 19368, 10518, 1779}},
        {{-4884, 428, 20255, -27002, -17930, 5806, -17845, 25761},
         {-112, 82, -12, -17, 23, -98, -83, 25, -23, -30, -95, 98, 70, 45, 92,
          50},
         {25, 8, 51, 56, 88, -71, -50, 78, 115, 124, 100, -66, 54, 5, 34, -57},
         {-7529, -3292, 10755, 32066, -14150, 6031, -14717, 22911}},

    };

    for (size_t i = 0; i < (sizeof(test_vec) / sizeof(test_vec[0])); i++) {
        int16x8_t a = vld1q_s16(test_vec[i].a);
        int8x16_t b = vld1q_s8(test_vec[i].b);
        int8x16_t c = vld1q_s8(test_vec[i].c);
        int16x8_t r = vmlal_high_s8(a, b, c);
        int16x8_t check = vld1q_s16(test_vec[i].r);
        ASSERT_EQUAL(r, check);
    }
    return 0;
}

TEST_CASE(test_vmlsl_s8) {
    static const struct {
        int16_t a[8];
        int8_t b[8];
        int8_t c[8];
        int16_t r[8];
    } test_vec[] = {
        {{31745, -21638, -25091, -30065, -22021, -2377, -25004, -16531},
         {71, -102, -119, -102, -113, -72, 35, -6},
         {93, 75, -4, -46, 41, INT8_MAX, -107, 43},
         {25142, -13988, -25567, 30779, -17388, 6767, -21259, -16273}},
        {{4091, -1578, 26028, -22653, 14863, 25502, 3032, 8226},
         {-91, -85, -70, 52, 100, -35, 46, -63},
         {41, 42, -109, 82, -87, 40, 125, -91},
         {7822, 1992, 18398, -26917, 23563, 26902, -2718, 2493}},
        {{21303, -7010, 8633, -14197, 10588, 13355, 19765, -9644},
         {-7, 15, 15, 93, -20, 61, 30, 21},
         {104, -79, 104, 17, -39, -27, -74, 16},
         {22031, -5825, 7073, -15778, 9808, 15002, 21985, -9980}},
        {{21561, -3340, -32650, -11590, -6743, -8698, 23346, 11193},
         {106, -56, -120, 86, 5, -90, 108, 109},
         {87, -44, INT8_MAX, 48, -71, 53, 65, -14},
         {12339, -5804, -17410, -15718, -6388, -3928, 16326, 12719}},
        {{13706, 228, -24907, 24530, -10109, -18883, -2509, -25119},
         {-66, 106, -12, -60, 16, 96, 49, 104},
         {52, -80, -104, -19, -26, -39, -32, 112},
         {17138, 8708, -26155, 23390, -9693, -15139, -941, 28769}},
        {{-15345, -15248, 16995, -6621, 24858, 20124, 32343, 5867},
         {-24, -33, -38, -8, 63, 11, 96, 115},
         {-68, -7, 97, -94, -46, 65, 18, -31},
         {-16977, -15479, 20681, -7373, 27756, 19409, 30615, 9432}},
        {{-32251, 26790, -13884, -8625, -5334, -32212, 6249, 20888},
         {-9, 114, 74, 55, 125, -86, -86, 57},
         {-93, 11, -37, 118, 76, -19, 87, 82},
         {32448, 25536, -11146, -15115, -14834, 31690, 13731, 16214}},
        {{-657, 13242, 2503, -3822, 16117, 24179, 2902, 20144},
         {125, -6, -123, -5, -92, 47, 52, 72},
         {59, 16, -66, -121, -3, 21, -39, 109},
         {-8032, 13338, -5615, -4427, 15841, 23192, 4930, 12296}}};

    for (size_t i = 0; i < (sizeof(test_vec) / sizeof(test_vec[0])); i++) {
        int16x8_t a = vld1q_s16(test_vec[i].a);
        int8x8_t b = vld1_s8(test_vec[i].b);
        int8x8_t c = vld1_s8(test_vec[i].c);
        int16x8_t r = vmlsl_s8(a, b, c);
        int16x8_t check = vld1q_s16(test_vec[i].r);
        ASSERT_EQUAL(r, check);
    }
    return 0;
}

TEST_CASE(test_vmlsl_high_s8) {
    static const struct {
        int16_t a[8];
        int8_t b[16];
        int8_t c[16];
        int16_t r[8];
    } test_vec[] = {
        {{-31077, 5466, 17188, 11098, 28477, -8315, 4954, -28534},
         {INT8_MIN, -20, 61, 84, -54, -49, 102, -70, 61, -15, 16, 22, -8, -34,
          21, -109},
         {101, 111, -88, -119, -78, 3, -76, -17, 114, 57, -50, -52, 77, 88, 92,
          -51},
         {27505, 6321, 17988, 12242, 29093, -5323, 3022, 31443}},
        {{-26300, 3618, -30615, -22840, -10119, 29372, -11849, 7173},
         {64, -82, -91, -13, -79, 89, -30, 35, -110, -79, -17, -33, 9, 75, -83,
          78},
         {-27, -49, 92, 78, 87, 37, -12, -47, -3, -80, 67, -76, -126, 72, -48,
          -62},
         {-26630, -2702, -29476, -25348, -8985, 23972, -15833, 12009}},
        {{30198, -22603, -26418, 25034, -18103, 21056, -4859, -5472},
         {-68, -3, 56, 20, 34, 44, -27, 31, -36, 40, -44, 94, 112, -92, 33,
          103},
         {26, -42, 14, -24, 110, -39, 73, -73, -110, -118, 10, -105, 119, -86,
          -127, 52},
         {26238, -17883, -25978, -30632, -31431, 13144, -668, -10828}},
        {{-18009, -14008, 11749, -15639, -17067, -15072, 16737, 31532},
         {24, 59, 100, -122, 20, -83, 62, -90, 55, 72, 62, -81, -14, -65, -29,
          -102},
         {121, 43, 99, 94, 88, 76, 32, -83, 9, 65, 114, 107, -126, -97, -26,
          -102},
         {-18504, -18688, 4681, -6972, -18831, -21377, 15983, 21128}},
        {{19162, -4575, 24568, 12180, -11609, -26146, -15982, 2867},
         {-20, -105, 105, 68, -29, -118, -15, -19, -53, 100, 88, 77, 3, 62, -24,
          -35},
         {-119, 9, -53, -127, 104, 95, -80, 15, 50, -113, -88, -60, 80, -36,
          -49, 61},
         {21812, 6725, 32312, 16800, -11849, -23914, -17158, 5002}},
        {{14451, 22145, 29634, -29373, -25641, -9509, -15398, 25527},
         {-52, -126, -28, 52, -31, -108, 67, 19, 35, -21, -41, 116, -57, -90,
          -79, 58},
         {-33, 50, -111, -95, -91, -44, 47, 124, 112, 10, 86, 74, -51, 13, -83,
          -103},
         {10531, 22355, -32376, 27579, -28548, -8339, -21955, 31501}},
        {{-28273, 29133, 4133, 18820, 23803, -15427, 28162, -7683},
         {-96, -114, -125, 70, 99, -78, -62, -45, -68, 25, 29, -119, 38, -54,
          34, -74},
         {91, -17, 39, INT8_MIN, -1, -85, -55, -6, 7, -122, -67, 10, -12, -69,
          -21, -107},
         {-27797, 32183, 6076, 20010, 24259, -19153, 28876, -15601}},
        {{28233, -21285, -25312, -9089, -25418, -8859, -30874, -15981},
         {118, -70, 66, 117, 101, 11, 112, 109, -110, 45, 119, -122, -24, 98,
          27, 50},
         {-47, -10, -34, -15, -108, 94, -50, 74, -6, 51, 39, 97, -69, -70, 34,
          49},
         {27573, -23580, -29953, 2745, -27074, -1999, -31792, -18431}}};

    for (size_t i = 0; i < (sizeof(test_vec) / sizeof(test_vec[0])); i++) {
        int16x8_t a = vld1q_s16(test_vec[i].a);
        int8x16_t b = vld1q_s8(test_vec[i].b);
        int8x16_t c = vld1q_s8(test_vec[i].c);
        int16x8_t r = vmlsl_high_s8(a, b, c);
        int16x8_t check = vld1q_s16(test_vec[i].r);
        ASSERT_EQUAL(r, check);
    }
    return 0;
}
