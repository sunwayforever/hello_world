// 2023-04-14 18:03
#include <neon.h>
#include <neon_test.h>
/* NOTE: 输出的 esize (向量中单个元素的宽度) 变成输入的两倍, 所以叫 widening */

// int16x8_t vaddl_s8(int8x8_t a,int8x8_t b)
//               ^--- l 后缀表示输出的 esize 是输入的两倍 (int8->int16)
// int32x4_t vaddl_s16(int16x4_t a,int16x4_t b)
// int64x2_t vaddl_s32(int32x2_t a,int32x2_t b)
// uint16x8_t vaddl_u8(uint8x8_t a,uint8x8_t b)
// uint32x4_t vaddl_u16(uint16x4_t a,uint16x4_t b)
// uint64x2_t vaddl_u32(uint32x2_t a,uint32x2_t b)
//
// int16x8_t vaddl_high_s8(int8x16_t a,int8x16_t b)
//                 ^--- high 表示只使用输入 vector 的后一半数据:
//                 r[i]=a[i+8]+b[i+8]
// int32x4_t vaddl_high_s16(int16x8_t a,int16x8_t b)
// int64x2_t vaddl_high_s32(int32x4_t a,int32x4_t b)
// uint16x8_t vaddl_high_u8(uint8x16_t a,uint8x16_t b)
// uint32x4_t vaddl_high_u16(uint16x8_t a,uint16x8_t b)
// uint64x2_t vaddl_high_u32(uint32x4_t a,uint32x4_t b)
//
// int16x8_t vaddw_s8(int16x8_t a,int8x8_t b)
//               ^--- esize(r)=esize(a)=2*esize(b)
// int32x4_t vaddw_s16(int32x4_t a,int16x4_t b)
// int64x2_t vaddw_s32(int64x2_t a,int32x2_t b)
// uint16x8_t vaddw_u8(uint16x8_t a,uint8x8_t b)
// uint32x4_t vaddw_u16(uint32x4_t a,uint16x4_t b)
// uint64x2_t vaddw_u32(uint64x2_t a,uint32x2_t b)
//
// int16x8_t vaddw_high_s8(int16x8_t a,int8x16_t b)
//               ^-^--- w_high 结合了 w 和 high
// int32x4_t vaddw_high_s16(int32x4_t a,int16x8_t b)
// int64x2_t vaddw_high_s32(int64x2_t a,int32x4_t b)
// uint16x8_t vaddw_high_u8(uint16x8_t a,uint8x16_t b)
// uint32x4_t vaddw_high_u16(uint32x4_t a,uint16x8_t b)
// uint64x2_t vaddw_high_u32(uint64x2_t a,uint32x4_t b)
//
TEST_CASE(test_vaddl_s8) {
    struct {
        int8_t a[8];
        int8_t b[8];
        int16_t r[8];
    } test_vec[] = {
        {{-101, 70, 78, 35, 52, -115, -75, 9},
         {-7, -86, 92, 121, 108, 119, 71, -69},
         {-108, -16, 170, 156, 160, 4, -4, -60}},
        {{84, -56, 30, 53, 70, 95, 116, 23},
         {117, 73, 119, -6, -59, -46, 109, 96},
         {201, 17, 149, 47, 11, 49, 225, 119}},
        {{24, -69, -124, 76, 72, 57, 86, 65},
         {-28, -78, -70, 80, 42, 2, 11, 126},
         {-4, -147, -194, 156, 114, 59, 97, 191}},
        {{-54, 42, -77, 16, -119, 40, 39, -2},
         {113, -97, -8, 55, 113, 101, -105, -119},
         {59, -55, -85, 71, -6, 141, -66, -121}},
        {{32, 27, -42, 105, 85, 44, -86, 57},
         {-34, 101, -119, 8, 103, -108, -122, 49},
         {-2, 128, -161, 113, 188, -64, -208, 106}},
        {{-66, 58, 65, 71, 98, 105, 69, -45},
         {8, 62, 10, 121, -93, -94, 2, -60},
         {-58, 120, 75, 192, 5, 11, 71, -105}},
        {{-67, -40, 45, 18, 4, -41, 75, -29},
         {60, -44, -21, -93, 105, 114, -44, 39},
         {-7, -84, 24, -75, 109, 73, 31, 10}},
        {{-84, 22, 111, 14, INT8_MAX, -76, -31, -121},
         {-14, -20, 0, -106, -114, 2, 90, 75},
         {-98, 2, 111, -92, 13, -74, 59, -46}},
    };

    for (size_t i = 0; i < (sizeof(test_vec) / sizeof(test_vec[0])); i++) {
        int8x8_t a = vld1_s8(test_vec[i].a);
        int8x8_t b = vld1_s8(test_vec[i].b);
        int16x8_t r = vaddl_s8(a, b);
        int16x8_t check = vld1q_s16(test_vec[i].r);
        ASSERT_EQUAL(r, check);
    }

    return 0;
}

TEST_CASE(test_vaddl_high_s8) {
    struct {
        int8_t a[16];
        int8_t b[16];
        int16_t r[8];
    } test_vec[] = {
        {{28, 57, 116, -26, -59, INT8_MIN, 27, 25, 118, -21, -106, 96, 91, -73,
          -21, -93},
         {19, -18, -14, 50, -30, 108, -16, 6, -106, 51, -85, 60, 49, -12, -61,
          78},
         {12, 30, -191, 156, 140, -85, -82, -15}},
        {{46, 55, 52, -13, -72, 79, 13, 46, 59, -93, -114, -106, 91, 122, 57,
          110},
         {104, 44, -96, 74, -104, -111, 80, 47, -60, -5, 107, -10, -16, 46, 68,
          30},
         {-1, -98, -7, -116, 75, 168, 125, 140}},
        {{102, 120, 17, 30, -57, 30, 76, 2, -62, -37, -104, 29, 85, -46, -117,
          -67},
         {-2, 44, 7, -106, -67, 87, -59, -127, 83, 49, 119, 67, 95, -69, 97,
          -59},
         {21, 12, 15, 96, 180, -115, -20, -126}},
        {{51, 114, -29, -5, -111, 48, -3, 83, 11, -106, 112, 96, 104, -5, 29,
          102},
         {39, 36, -4, -28, 123, -62, 102, -50, -13, -35, 17, 82, -103, 114, 24,
          -52},
         {-2, -141, 129, 178, 1, 109, 53, 50}},
        {{-27, -5, -57, 118, 43, -59, -55, 54, 91, 57, -106, -61, 52, -77, 41,
          92},
         {-41, 37, 64, 83, -25, -90, 33, -38, -124, 51, 45, 29, -91, 69, -23,
          -118},
         {-33, 108, -61, -32, -39, -8, 18, -26}},
        {{64, -79, 0, 108, 118, -55, -94, -47, 2, 57, -108, 55, -20, -67, -109,
          -60},
         {-30, -45, 23, -54, 122, 56, -92, -2, 107, -47, 27, 17, 22, 4, -101,
          87},
         {109, 10, -81, 72, 2, -63, -210, 27}},
        {{-75, -100, -61, 43, 101, 101, -4, 104, -98, -112, -97, -117, 77, 50,
          79, 48},
         {5, 102, -6, INT8_MAX, -98, -98, 125, 10, 112, -104, 27, -122, -99,
          -74, -35, 82},
         {14, -216, -70, -239, -22, -24, 44, 130}},
        {{82, -96, 126, -72, 6, 122, 32, -92, 11, -65, 47, 88, -15, 126, -120,
          -10},
         {-28, -126, 118, -125, 33, -13, -115, -111, -116, -88, 23, 41, 94, -11,
          123, -79},
         {-105, -153, 70, 129, 79, 115, 3, -89}},
    };

    for (size_t i = 0; i < (sizeof(test_vec) / sizeof(test_vec[0])); i++) {
        int8x16_t a = vld1q_s8(test_vec[i].a);
        int8x16_t b = vld1q_s8(test_vec[i].b);
        int16x8_t r = vaddl_high_s8(a, b);
        int16x8_t check = vld1q_s16(test_vec[i].r);

        ASSERT_EQUAL(r, check);
    }
    return 0;
}

TEST_CASE(test_vaddw_s8) {
    struct {
        int16_t a[8];
        int8_t b[8];
        int16_t r[8];
    } test_vec[] = {
        {{1399, -17500, -22993, -21510, 23499, 6907, 18650, -25560},
         {-17, 18, -39, -77, 69, 53, 99, 113},
         {1382, -17482, -23032, -21587, 23568, 6960, 18749, -25447}},
        {{2134, -30371, 8145, 18599, 19236, 21252, -271, -16898},
         {89, -7, -41, 51, 65, 0, -49, 49},
         {2223, -30378, 8104, 18650, 19301, 21252, -320, -16849}},
        {{-22254, 22500, 18398, 13768, 9807, 8638, 25925, 27241},
         {-80, 109, -67, -94, 108, -68, 95, -59},
         {-22334, 22609, 18331, 13674, 9915, 8570, 26020, 27182}},
        {{14005, -2055, -14282, 18472, 3185, 20639, 26707, -23931},
         {-114, 67, -61, -45, -87, 45, 61, 89},
         {13891, -1988, -14343, 18427, 3098, 20684, 26768, -23842}},
        {{-1126, 1787, 23223, 27852, -14959, -14493, -29811, -240},
         {-105, -81, 79, -22, 23, -44, -115, -91},
         {-1231, 1706, 23302, 27830, -14936, -14537, -29926, -331}},
        {{20503, -16263, -18819, 6170, 5553, 26654, -5520, 469},
         {-81, 56, -56, 61, -60, -40, 60, 91},
         {20422, -16207, -18875, 6231, 5493, 26614, -5460, 560}},
        {{-29816, -24762, -11425, 30277, -16861, -24265, 20852, 9913},
         {102, -41, -114, -42, -62, 99, -41, 113},
         {-29714, -24803, -11539, 30235, -16923, -24166, 20811, 10026}},
        {{-24420, 24750, -5512, 187, 373, -11104, -6700, -1973},
         {-93, -126, -103, 23, -45, 82, 61, 57},
         {-24513, 24624, -5615, 210, 328, -11022, -6639, -1916}},
    };

    for (size_t i = 0; i < (sizeof(test_vec) / sizeof(test_vec[0])); i++) {
        int16x8_t a = vld1q_s16(test_vec[i].a);
        int8x8_t b = vld1_s8(test_vec[i].b);
        int16x8_t r = vaddw_s8(a, b);
        int16x8_t check = vld1q_s16(test_vec[i].r);
        ASSERT_EQUAL(r, check);
    }
    return 0;
}

TEST_CASE(test_vaddw_high_s8) {
    static const struct {
        int16_t a[8];
        int8_t b[16];
        int16_t r[8];
    } test_vec[] = {
        {{23541, 10181, -30920, 29810, -14369, 8626, -8621, 19588},
         {120, -90, -45, -11, 119, -3, 3, 41, -7, -7, 1, -118, 56, 21, 0, 45},
         {23534, 10174, -30919, 29692, -14313, 8647, -8621, 19633}},
        {{-14992, -22187, -14516, 11037, -12401, -7604, -11858, 9774},
         {119, 1, 27, -18, -1, 31, 24, -8, 24, 25, -126, 80, 46, -126, 126,
          -97},
         {-14968, -22162, -14642, 11117, -12355, -7730, -11732, 9677}},
        {{-11449, -27832, 26010, 10687, 2869, -7412, 15068, 21257},
         {60, 36, 66, 59, 67, 90, 51, 92, 115, -75, -84, -94, 55, 42, 65, 126},
         {-11334, -27907, 25926, 10593, 2924, -7370, 15133, 21383}},
        {{-30211, -26607, -12050, 9153, -12836, -18426, 3848, 17420},
         {52, 78, INT8_MAX, 119, -88, -78, -45, 27, 103, INT8_MIN, -67, -98,
          -86, -2, 28, -88},
         {-30108, -26735, -12117, 9055, -12922, -18428, 3876, 17332}},
        {{11655, 30272, 510, -9575, -24369, -10350, -24913, -7397},
         {-20, -102, 91, -108, 76, 46, -80, -77, -82, 109, 81, 89, 108, 109, 1,
          -13},
         {11573, 30381, 591, -9486, -24261, -10241, -24912, -7410}},
        {{16794, -26519, 834, 4466, 1443, 21224, 931, -28618},
         {-99, -111, 36, -23, -65, -44, -100, 110, 66, -19, -57, -82, 90, -56,
          -95, -11},
         {16860, -26538, 777, 4384, 1533, 21168, 836, -28629}},
        {{2825, 19341, 14, -20131, 17669, -22525, 14665, -6600},
         {-54, 93, -48, -118, 49, 108, -8, 115, 90, -65, 33, -76, -121, -61,
          -87, -112},
         {2915, 19276, 47, -20207, 17548, -22586, 14578, -6712}},
        {{14286, -8997, 14391, 15501, -28546, -14364, 7626, -27475},
         {122, 125, 30, -85, -22, 22, 31, 68, -43, 64, -8, 92, 3, -94, -20,
          -47},
         {14243, -8933, 14383, 15593, -28543, -14458, 7606, -27522}}};

    for (size_t i = 0; i < (sizeof(test_vec) / sizeof(test_vec[0])); i++) {
        int16x8_t a = vld1q_s16(test_vec[i].a);
        int8x16_t b = vld1q_s8(test_vec[i].b);
        int16x8_t r = vaddw_high_s8(a, b);
        int16x8_t check = vld1q_s16(test_vec[i].r);
        ASSERT_EQUAL(r, check);
    }
    return 0;
}
