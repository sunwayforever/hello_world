// 2023-04-19 19:17
#include <neon.h>
#include <neon_test.h>
// int8x8_t vshrn_n_s16(int16x8_t a,const int n)
//              ^---narrow
// int16x4_t vshrn_n_s32(int32x4_t a,const int n)
// int32x2_t vshrn_n_s64(int64x2_t a,const int n)
// uint8x8_t vshrn_n_u16(uint16x8_t a,const int n)
// uint16x4_t vshrn_n_u32(uint32x4_t a,const int n)
// uint32x2_t vshrn_n_u64(uint64x2_t a,const int n)
// --------------------------------------------------------------
// int8x16_t vshrn_high_n_s16(int8x8_t a,int16x8_t b,const int n)
//                 ^^^^---r[i+8]=b[i]>>n, r[i]=a[i], 这里的 high 和前面的 high
//                 有点不同: 它表示使用输出的后一半数据, 而不是输入的后一半数据
// int16x8_t vshrn_high_n_s32(int16x4_t r,int32x4_t a,const int n)
// int32x4_t vshrn_high_n_s64(int32x2_t r,int64x2_t a,const int n)
// uint8x16_t vshrn_high_n_u16(uint8x8_t r,uint16x8_t a,const int n)
// uint16x8_t vshrn_high_n_u32(uint16x4_t r,uint32x4_t a,const int n)
// uint32x4_t vshrn_high_n_u64(uint32x2_t r,uint64x2_t a,const int n)

TEST_CASE(test_vshrn_n_s16) {
    struct {
        int16_t a[8];
        int8_t r1[8];
        int8_t r3[8];
        int8_t r5[8];
        int8_t r6[8];
        int8_t r8[8];
    } test_vec[] = {
        {{6741, 21476, -32351, 11296, 4310, -29246, -6240, -26445},
         {42, -14, -48, 16, 107, -31, -48, 89},
         {74, 124, 52, -124, 26, -72, -12, 22},
         {-46, -97, 13, 97, -122, 110, 61, -59},
         {105, 79, 6, -80, 67, 55, -98, 98},
         {26, 83, -127, 44, 16, -115, -25, -104}},
        {{11615, -11508, -4296, -14439, -15492, 11205, 16637, 21157},
         {-81, -122, -100, -52, -66, -30, 126, 82},
         {-85, 97, -25, -13, 111, 120, 31, 84},
         {106, -104, 121, 60, 27, 94, 7, -107},
         {-75, 76, -68, 30, 13, -81, 3, 74},
         {45, -45, -17, -57, -61, 43, 64, 82}},
        {{-30374, -859, -14838, -8152, -5418, 30317, 8401, 12302},
         {-83, 82, 5, 20, 107, 54, 104, 7},
         {43, -108, -63, 5, 90, -51, 26, 1},
         {74, -27, 48, 1, 86, -77, 6, INT8_MIN},
         {37, -14, 24, INT8_MIN, -85, -39, -125, -64},
         {-119, -4, -58, -32, -22, 118, 32, 48}},
        {{6989, -31229, -25334, -31155, 4704, 23985, 22099, -21073},
         {-90, 1, -123, 38, 48, -40, 41, -41},
         {105, -64, -95, -55, 76, -74, -54, -75},
         {-38, 48, -24, 50, -109, -19, -78, 109},
         {109, 24, 116, 25, 73, 118, 89, -74},
         {27, -122, -99, -122, 18, 93, 86, -83}},
        {{21983, -5719, -12005, -3639, 14011, -29593, 30039, -23364},
         {-17, -44, -115, -28, 93, 51, -85, 94},
         {-69, 53, 35, 57, -41, -116, -86, -105},
         {-82, 77, -120, -114, -75, 99, -86, 37},
         {87, -90, 68, -57, -38, 49, -43, -110},
         {85, -23, -47, -15, 54, -116, 117, -92}},
        {{-16240, -25814, 30813, -17119, -11382, -8933, -13783, 2443},
         {72, -107, 46, -112, -59, -115, 20, -59},
         {18, 101, 11, -92, 113, -93, 69, 49},
         {4, -39, -62, -23, -100, -24, 81, 76},
         {2, 108, -31, -12, 78, 116, 40, 38},
         {-64, -101, 120, -67, -45, -35, -54, 9}},
        {{13343, 15090, -17402, -16085, -27918, 18766, 2568, -26386},
         {15, 121, 3, -107, 121, -89, 4, 119},
         {-125, 94, INT8_MIN, 37, 94, 41, 65, 29},
         {-96, -41, -32, 9, -105, 74, 80, -57},
         {-48, -21, -16, 4, 75, 37, 40, 99},
         {52, 58, -68, -63, -110, 73, 10, -104}},
        {{6346, 10035, 21904, 7141, 40, 20984, -31798, -5542},
         {101, -103, -56, -14, 20, -4, -27, 45},
         {25, -26, -78, 124, 5, 63, 121, 75},
         {-58, 57, -84, -33, 1, -113, 30, 82},
         {99, -100, 86, 111, 0, 71, 15, -87},
         {24, 39, 85, 27, 0, 81, -125, -22}},
    };

    for (size_t i = 0; i < (sizeof(test_vec) / sizeof(test_vec[0])); i++) {
        int16x8_t a = vld1q_s16(test_vec[i].a);

        int8x8_t r1 = vshrn_n_s16(a, 1);
        int8x8_t r3 = vshrn_n_s16(a, 3);
        int8x8_t r5 = vshrn_n_s16(a, 5);
        int8x8_t r6 = vshrn_n_s16(a, 6);
        int8x8_t r8 = vshrn_n_s16(a, 8);

        int8x8_t check1 = vld1_s8(test_vec[i].r1);
        int8x8_t check3 = vld1_s8(test_vec[i].r3);
        int8x8_t check5 = vld1_s8(test_vec[i].r5);
        int8x8_t check6 = vld1_s8(test_vec[i].r6);
        int8x8_t check8 = vld1_s8(test_vec[i].r8);

        ASSERT_EQUAL(r1, check1);
        ASSERT_EQUAL(r3, check3);
        ASSERT_EQUAL(r5, check5);
        ASSERT_EQUAL(r6, check6);
        ASSERT_EQUAL(r8, check8);
    }

    return 0;
}

TEST_CASE(test_vshrn_high_n_s16) {
    struct {
        int8_t a[8];
        int16_t b[8];
        int8_t r[16];
    } test_vec[] = {
        {{42, -14, -48, 16, 107, -31, -48, 89},
         {6741, 21476, -32351, 11296, 4310, -29246, -6240, -26445},
         {42, -14, -48, 16, 107, -31, -48, 89, 74, 124, 52, -124, 26, -72, -12,
          22}},
        {{-81, -122, -100, -52, -66, -30, 126, 82},
         {11615, -11508, -4296, -14439, -15492, 11205, 16637, 21157},
         {-81, -122, -100, -52, -66, -30, 126, 82, -85, 97, -25, -13, 111, 120,
          31, 84}},
        {{-83, 82, 5, 20, 107, 54, 104, 7},
         {-30374, -859, -14838, -8152, -5418, 30317, 8401, 12302},
         {-83, 82, 5, 20, 107, 54, 104, 7, 43, -108, -63, 5, 90, -51, 26, 1}},
        {{-90, 1, -123, 38, 48, -40, 41, -41},
         {6989, -31229, -25334, -31155, 4704, 23985, 22099, -21073},
         {-90, 1, -123, 38, 48, -40, 41, -41, 105, -64, -95, -55, 76, -74, -54,
          -75}},
        {{-17, -44, -115, -28, 93, 51, -85, 94},
         {21983, -5719, -12005, -3639, 14011, -29593, 30039, -23364},
         {-17, -44, -115, -28, 93, 51, -85, 94, -69, 53, 35, 57, -41, -116, -86,
          -105}},
    };

    for (size_t i = 0; i < (sizeof(test_vec) / sizeof(test_vec[0])); i++) {
        int8x8_t a = vld1_s8(test_vec[i].a);
        int16x8_t b = vld1q_s16(test_vec[i].b);
        int8x16_t r = vshrn_high_n_s16(a, b, 3);
        int8x16_t check = vld1q_s8(test_vec[i].r);
        ASSERT_EQUAL(r, check);
    }
    return 0;
}
